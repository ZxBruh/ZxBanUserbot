import sys
import os
import json
import subprocess
import asyncio
from pyrogram import Client, filters

# –ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
CONFIG_FILE = "user_config.json"

# –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
default_config = {
    "info_template": "<b>‚ÑπÔ∏è –ò–Ω—Ñ–æ:</b> zxban –∞–∫—Ç–∏–≤–µ–Ω!",
    "ping_template": "<b>‚è± –ü–∏–Ω–≥:</b> {time} –º—Å",
    "help_template": "<b>üìú –°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥:</b>\n!—Ö–µ–ª–ø\n!–∫—Ñ–≥\n!–µ\n!—Ç–µ—Ä–º–∏–Ω–∞–ª"
}

# –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞
if not os.path.exists(CONFIG_FILE):
    with open(CONFIG_FILE, "w", encoding="utf-8") as f:
        json.dump(default_config, f, ensure_ascii=False, indent=4)

def load_config():
    with open(CONFIG_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

def save_config(config):
    with open(CONFIG_FILE, "w", encoding="utf-8") as f:
        json.dump(config, f, ensure_ascii=False, indent=4)

app = Client("my_account")

@app.on_message(filters.me & filters.command("—Ö–µ–ª–ø", prefixes="!"))
async def help_cmd(client, message):
    config = load_config()
    await message.edit(config["help_template"])

@app.on_message(filters.me & filters.command("–∫—Ñ–≥", prefixes="!"))
async def config_cmd(client, message):
    config = load_config()
    args = message.text.split(maxsplit=2)
    
    if len(args) < 3:
        await message.edit("<b>–§–æ—Ä–º–∞—Ç:</b> !–∫—Ñ–≥ [–ø–∏–Ω–≥/–∏–Ω—Ñ–æ/—Ö–µ–ª–ø] [—Ç–µ–∫—Å—Ç]")
        return

    key = args[1].lower()
    value = args[2]

    if key == "–ø–∏–Ω–≥":
        config["ping_template"] = value
    elif key == "–∏–Ω—Ñ–æ":
        config["info_template"] = value
    elif key == "—Ö–µ–ª–ø":
        config["help_template"] = value
    else:
        await message.edit("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á. –ò—Å–ø–æ–ª—å–∑—É–π: –ø–∏–Ω–≥, –∏–Ω—Ñ–æ, —Ö–µ–ª–ø.")
        return

    save_config(config)
    await message.edit(f"‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ <b>{key}</b> –æ–±–Ω–æ–≤–ª–µ–Ω–∞!")

@app.on_message(filters.me & filters.command("–µ", prefixes="!"))
async def execute_cmd(client, message):
    code = message.text.split(maxsplit=1)[1] if len(message.text.split()) > 1 else None
    if not code:
        return await message.edit("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è!")
    
    await message.edit("<b>–í—ã–ø–æ–ª–Ω—è—é...</b>")
    try:
        # –ó–¥–µ—Å—å –º—ã –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—ã–≤–æ–¥ print()
        import io
        from contextlib import redirect_stdout
        f = io.StringIO()
        with redirect_stdout(f):
            exec(code)
        out = f.getvalue()
        await message.edit(f"<b>–ö–æ–¥:</b>\n<code>{code}</code>\n\n<b>–†–µ–∑—É–ª—å—Ç–∞—Ç:</b>\n<code>{out}</code>")
    except Exception as e:
        await message.edit(f"<b>–û—à–∏–±–∫–∞:</b>\n<code>{e}</code>")

@app.on_message(filters.me & filters.command("—Ç–µ—Ä–º–∏–Ω–∞–ª", prefixes="!"))
async def terminal_cmd(client, message):
    cmd = message.text.split(maxsplit=1)[1] if len(message.text.split()) > 1 else None
    if not cmd:
        return await message.edit("–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É —Ç–µ—Ä–º–∏–Ω–∞–ª–∞!")

    await message.edit(f"<b>–ó–∞–ø—É—Å–∫:</b> <code>{cmd}</code>")
    process = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    stdout, stderr = process.communicate()
    
    result = stdout or stderr
    await message.edit(f"<b>–¢–µ—Ä–º–∏–Ω–∞–ª:</b>\n<code>{result}</code>")

app.run()
